

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Interrupt and Exception Handling File: intexc_&lt;device&gt;.S &mdash; NMSIS 1.0.0-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Device Linker Script: gcc_&lt;device&gt;.ld" href="core_template_linker_device.html" />
    <link rel="prev" title="Startup File startup_&lt;device&gt;.S" href="core_template_startup_device.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/nmsis_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/introduction.html">Nuclei MCU Software Interface Standard(NMSIS)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">NMSIS Core</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html">Using NMSIS in Embedded Applications</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="core_templates.html">NMSIS-Core Device Templates</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="core_templates.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="core_templates.html#nmsis-core-processor-files">NMSIS-Core Processor Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="core_templates.html#device-examples">Device Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="core_templates.html#template-files">Template Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="core_templates.html#adapt-template-files-to-a-device">Adapt Template Files to a Device</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="core_templates.html#device-templates-explaination">Device Templates Explaination</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="core_template_startup_device.html">Startup File startup_&lt;device&gt;.S</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Interrupt and Exception Handling File: intexc_&lt;device&gt;.S</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#nmi-non-maskable-interrupt">NMI(Non-Maskable Interrupt)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#exception">Exception</a></li>
<li class="toctree-l5"><a class="reference internal" href="#interrupt">Interrupt</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#non-vector-interrupt-sw-handler">Non-Vector Interrupt SW handler</a></li>
<li class="toctree-l6"><a class="reference internal" href="#vector-interrupt-sw-handler">Vector Interrupt SW handler</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#intexc-device-s-template-file">intexc_Device.S Template File</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="core_template_linker_device.html">Device Linker Script: gcc_&lt;device&gt;.ld</a></li>
<li class="toctree-l4"><a class="reference internal" href="core_template_system_device.html">System Configuration Files system_&lt;device&gt;.c and system_&lt;device&gt;.h</a></li>
<li class="toctree-l4"><a class="reference internal" href="core_template_device_header.html">Device Header File &lt;device.h&gt;</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="register_mapping.html">Register Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/index.html">NMSIS Core API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dsp/index.html">NMSIS DSP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nn/index.html">NMSIS NN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NMSIS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">NMSIS Core</a> &raquo;</li>
        
          <li><a href="core_templates.html">NMSIS-Core Device Templates</a> &raquo;</li>
        
      <li>Interrupt and Exception Handling File: intexc_&lt;device&gt;.S</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/core/core_template_intexc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interrupt-and-exception-handling-file-intexc-device-s">
<span id="core-template-intexc-device"></span><h1>Interrupt and Exception Handling File: intexc_&lt;device&gt;.S<a class="headerlink" href="#interrupt-and-exception-handling-file-intexc-device-s" title="Permalink to this headline">¶</a></h1>
<dl class="simple">
<dt>The <strong>intexc File intexc_&lt;device&gt;.S</strong> contains:</dt><dd><ul class="simple">
<li><p>Macro to save caller register.</p></li>
<li><p>Macro to restore caller register.</p></li>
<li><p>Default Exception/NMI routine implementation.</p></li>
<li><p>Default Non-Vector Interrupt routine implementation.</p></li>
</ul>
</dd>
</dl>
<p>Nuclei processors provide <strong>NMI(Non-Maskable Interrupt)</strong>, <strong>Exception</strong>,
<strong>Vector Interrupt</strong> and <strong>Non-Vector Interrupt</strong> features.</p>
<div class="section" id="nmi-non-maskable-interrupt">
<h2>NMI(Non-Maskable Interrupt)<a class="headerlink" href="#nmi-non-maskable-interrupt" title="Permalink to this headline">¶</a></h2>
<p>NMI is used for urgent external HW error. It can’t be masked and disabled.</p>
<p>When NMI happened, bit 9 of CSR <code class="docutils literal notranslate"><span class="pre">MMSIC_CTL</span></code> will be checked.
If this bit value is 1, then NMI entry address will be the same as exception(CSR_MTVEC), and exception code for NMI will be 0xFFF, otherwise NMI entry will be same as reset_vector.</p>
<p>In NMSIS-Core, the bit 9 of CSR <code class="docutils literal notranslate"><span class="pre">MMISC_CTL</span></code> is set to 1 during core startup, so NMI will be treated as Exception and handled.</p>
</div>
<div class="section" id="exception">
<h2>Exception<a class="headerlink" href="#exception" title="Permalink to this headline">¶</a></h2>
<p>For CPU exception, the entry for exception will be <code class="docutils literal notranslate"><span class="pre">exc_entry</span></code>, in this entry code, it will call default exception handler <a class="reference internal" href="api/core_system_device.html#_CPPv422core_exception_handlermm" title="core_exception_handler"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">core_exception_handler()</span></code></a>.</p>
<p>In the common exception routine(<code class="docutils literal notranslate"><span class="pre">exc_entry</span></code>) to get more information like exception code.
Exception handle flow show as below picture:</p>
<a class="reference internal image-reference" href="../_images/NMSIS_exception.png"><img alt="NMSIS-Intexc User Files" src="../_images/NMSIS_exception.png" style="width: 327.20000000000005px; height: 428.0px;" /></a>
<p>NMI and exception could support nesting. Two levels of NMI/Exception state save stacks are supported.</p>
<p>We support three nesting mode as below:</p>
<ul class="simple">
<li><p>NMI nesting exception</p></li>
<li><p>Exception nesting exception</p></li>
<li><p>Exception nesting NMI</p></li>
</ul>
<p>For software, we have provided the common entry for NMI and exception. Silicon vendor only need adapt the interface defined in <a class="reference internal" href="api/core_system_device.html#core-api-intexc-nmi-handling"><span class="std std-ref">Interrupt Exception NMI Handling</span></a>.</p>
<p>Context save and restore have been handled by <code class="docutils literal notranslate"><span class="pre">exc_entry</span></code> interface.</p>
<p>When exception exception return it will run the intruction which trigger the exception again. It will cause software dead loop. So in the exception handler for each exception code, we propose to set CSR <code class="docutils literal notranslate"><span class="pre">MEPC</span></code> to be <code class="docutils literal notranslate"><span class="pre">MEPC+4</span></code>, then it will start from next instruction of MEPC.</p>
</div>
<div class="section" id="interrupt">
<h2>Interrupt<a class="headerlink" href="#interrupt" title="Permalink to this headline">¶</a></h2>
<p>Interrupt could be configured as <strong>CLINT</strong> mode or <strong>ECILC</strong> mode.</p>
<p>In NMSIS-Core, Interrupt has been configured as <strong>ECLIC</strong> mode during startup in <em>startup_&lt;Devices&gt;.S</em>, which is also recommended setting using Nuclei Processors.</p>
<p>ECLIC managed interrupt could configured as <strong>vector</strong> and <strong>non-vector</strong> mode.</p>
<p>Detail interrupt handling process as below picture:</p>
<a class="reference internal image-reference" href="../_images/NMSIS_intexc.png"><img alt="NMSIS-intexc User Files" src="../_images/NMSIS_intexc.png" style="width: 758.4000000000001px; height: 807.2px;" /></a>
<p>To get highest priority interrupt we need compare the interrupt level first.If level is the same then compare the priority. High level interrupt could interrupt low level
ISR and trigger interrupt nesting. If different priority with same level interrupt pending higher priority will be served first. Interrupt could be configured as vector mode
and non-vector mode by vendor. For non-vector mode interrupt handler entry get from MTVT2 and exception/NMI handler entry get from MTVEC. If Vendor need set non vector mode
interrupt handler entry from <code class="docutils literal notranslate"><span class="pre">MTVVEC</span></code> you need set <code class="docutils literal notranslate"><span class="pre">MTVT2.BIT0</span></code> as 0.</p>
<div class="section" id="non-vector-interrupt-sw-handler">
<h3>Non-Vector Interrupt SW handler<a class="headerlink" href="#non-vector-interrupt-sw-handler" title="Permalink to this headline">¶</a></h3>
<p>For <strong>non-vector</strong> mode interrupt it will make the necessary CSR registers and context save and restore.
Non-vector mode software handle flow show as below pciture:</p>
<a class="reference internal image-reference" href="../_images/NMSIS_Interrupt_Nonvec_SW_flow.png"><img alt="NMSIS-intexc User Files" src="../_images/NMSIS_Interrupt_Nonvec_SW_flow.png" style="width: 343.20000000000005px; height: 456.8px;" /></a>
<p><strong>Detail description for non-vector mode interrupt handler as below steps:</strong></p>
<ol class="arabic simple">
<li><p>Get non-vector mode handler entry from <code class="docutils literal notranslate"><span class="pre">MTVT2</span></code> if <code class="docutils literal notranslate"><span class="pre">MTVT2.BIT0</span></code> is 1(proposed configuration).</p></li>
<li><p>Context save to stack for cpu registers.</p></li>
<li><p>Save CSR registers <code class="docutils literal notranslate"><span class="pre">MEPC/MCAUSE/MSUBM</span></code> to stack.</p></li>
<li><p>Run instruction <code class="docutils literal notranslate"><span class="pre">csrrw</span> <span class="pre">ra,</span> <span class="pre">CSR_JALMNXTI,</span> <span class="pre">ra</span></code>. It will enable interrupt, check interrupt pending. If interrupt is pending then get highest priority interrupt and jump to interrupt handler entry in the vector table, otherwise it will go to step 6.</p></li>
<li><p>Execute the interrupt handler routine, when return from isr routine it will jump to step 4.</p></li>
<li><p>Global interrupt disable.</p></li>
<li><p>Restore CSR registers <code class="docutils literal notranslate"><span class="pre">MEPC/MCAUSE/MSUBM</span></code>.</p></li>
<li><p>Context restore from stack for cpu registers.</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">mret</span></code> to return from handler.</p></li>
</ol>
<p>For <strong>non-vector</strong> mode iterrupt it could support <strong>interrupt nesting</strong>.</p>
<p><strong>Interrupt nesting</strong> handle flow show as below picture:</p>
<a class="reference internal image-reference" href="../_images/NMSIS_Interrupt_Nonvec_Nesting_SW_flow.png"><img alt="NMSIS-intexc User Files" src="../_images/NMSIS_Interrupt_Nonvec_Nesting_SW_flow.png" style="width: 722.4000000000001px; height: 325.6px;" /></a>
</div>
<div class="section" id="vector-interrupt-sw-handler">
<h3>Vector Interrupt SW handler<a class="headerlink" href="#vector-interrupt-sw-handler" title="Permalink to this headline">¶</a></h3>
<p>If vector interrupt handler need support nesting or making function call Vector mode software handling flow show as below picture:</p>
<a class="reference internal image-reference" href="../_images/NMSIS_Nesting_Vector_Interrupt_SW_flow.png"><img alt="NMSIS-intexc User Files" src="../_images/NMSIS_Nesting_Vector_Interrupt_SW_flow.png" style="width: 156.8px; height: 387.20000000000005px;" /></a>
<p><strong>Detail description for nested vector mode interrupt handler as below steps:</strong></p>
<ol class="arabic simple">
<li><p>Get vector mode handler from address of vector table entry <code class="docutils literal notranslate"><span class="pre">MTVT</span></code> added offset.</p></li>
<li><p>Context save to stack for cpu registers, done in each vector interrupt handler via <a class="reference internal" href="api/core_compiler_control.html#c.__INTERRUPT" title="__INTERRUPT"><code class="xref c c-macro docutils literal notranslate"><span class="pre">__INTERRUPT</span></code></a></p></li>
<li><p>Save CSR registers <code class="docutils literal notranslate"><span class="pre">MEPC/MCAUSE/MSUBM</span></code> to stack, done in each vector interrupt handler by read and save these CSRs into variables.</p></li>
<li><p>Execute the interrupt handling.</p></li>
<li><p>Restore CSR registers <code class="docutils literal notranslate"><span class="pre">MEPC/MCAUSE/MSUBM</span></code> from stack.</p></li>
<li><p>CSR registers restore from saved variables used in step 3.</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">mret</span></code> to return from handler</p></li>
</ol>
<p>Here is sample code for above nested vector interrupt handling process:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Vector interrupt handler for on-board button</span>
<span class="n">__INTERRUPT</span> <span class="kt">void</span> <span class="nf">SOC_BUTTON_1_HANDLER</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// save mepc,mcause,msubm enable interrupts</span>
    <span class="n">SAVE_IRQ_CSR_CONTEXT</span><span class="p">();</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;----Begin button1 handler----Vector mode</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// Green LED toggle</span>
    <span class="n">gpio_toggle</span><span class="p">(</span><span class="n">GPIO</span><span class="p">,</span> <span class="n">SOC_LED_GREEN_GPIO_MASK</span><span class="p">);</span>

    <span class="c1">// Clear the GPIO Pending interrupt by writing 1.</span>
    <span class="n">gpio_clear_interrupt</span><span class="p">(</span><span class="n">GPIO</span><span class="p">,</span> <span class="n">SOC_BUTTON_1_GPIO_OFS</span><span class="p">,</span> <span class="n">GPIO_INT_RISE</span><span class="p">);</span>

    <span class="n">wait_seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Wait for a while</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;----End button1 handler</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// disable interrupts,restore mepc,mcause,msubm</span>
    <span class="n">RESTORE_IRQ_CSR_CONTEXT</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Detail description for non-nested vector mode interrupt handler as below</strong></p>
<p>To improve the software response latency for vector mode vendor could remove context save/restore and <strong>MEPC/MCAUSE/MSUBM</strong> save/restore.</p>
<p>If so vector mode interrupt will not support nesting and interrupt handler can only be a leaf function which doesn’t make any function calls.</p>
<p><strong>Then the vector mode interrupt software flow will be described as below:</strong></p>
<ol class="arabic simple">
<li><p>Get vector mode handler from address of vector table entry <code class="docutils literal notranslate"><span class="pre">MTVT</span></code> added offset.</p></li>
<li><p>Execute the interrupt handler(leaf function).</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">mret</span></code> to return from handler</p></li>
</ol>
<p>Here is sample code for above non-nested vector interrupt handler which is a leaf function handling process:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">btn_pressed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Vector interrupt handler for on-board button</span>
<span class="c1">// This function is an leaf function, no function call is allowed</span>
<span class="kt">void</span> <span class="nf">SOC_BUTTON_1_HANDLER</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">btn_pressed</span> <span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="intexc-device-s-template-file">
<h2>intexc_Device.S Template File<a class="headerlink" href="#intexc-device-s-template-file" title="Permalink to this headline">¶</a></h2>
<p>The file exists for each supported toolchain and is the only toolchain specific NMSIS file.</p>
<p>Normally this file needn’t adapt for different device. If CPU CSR registers have done some
changes you may need some adaption.</p>
<p>Here we provided <code class="docutils literal notranslate"><span class="pre">intexc_Device.S</span></code> template file as below:</p>
<div class="highlight-asm notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></div></td><td class="code"><div class="highlight"><pre><span></span>/*
 * Copyright (c) 2019 Nuclei Limited. All rights reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Licensed under the Apache License, Version 2.0 (the License); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an AS IS BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/******************************************************************************
 * \file     intexc_&lt;Device&gt;.S
 * \brief    NMSIS Interrupt and Exception Handling Template File
 *           for Nuclei N/NX Class Device
 * \version  V1.00
 * \date     25 Dec 2019
 *
 ******************************************************************************/

#include &quot;riscv_encoding.h&quot;

/**
 * \brief  Global interrupt disabled
 * \details
 *  This function disable global interrupt.
 * \remarks
 *  - All the interrupt requests will be ignored by CPU.
 */
.macro DISABLE_MIE
    csrc CSR_MSTATUS, MSTATUS_MIE
.endm

/**
 * \brief  Macro for context save
 * \details
 * This macro save ABI defined caller saved registers in the stack.
 * \remarks
 * - This Macro could use to save context when you enter to interrupt
 * or exception
*/
/* Save caller registers */
.macro SAVE_CONTEXT
    /* Allocate stack space for context saving */
#ifndef __riscv_32e
    addi sp, sp, -20*REGBYTES
#else
    addi sp, sp, -14*REGBYTES
#endif /* __riscv_32e */

    STORE x1, 0*REGBYTES(sp)
    STORE x4, 1*REGBYTES(sp)
    STORE x5, 2*REGBYTES(sp)
    STORE x6, 3*REGBYTES(sp)
    STORE x7, 4*REGBYTES(sp)
    STORE x10, 5*REGBYTES(sp)
    STORE x11, 6*REGBYTES(sp)
    STORE x12, 7*REGBYTES(sp)
    STORE x13, 8*REGBYTES(sp)
    STORE x14, 9*REGBYTES(sp)
    STORE x15, 10*REGBYTES(sp)
#ifndef __riscv_32e
    STORE x16, 14*REGBYTES(sp)
    STORE x17, 15*REGBYTES(sp)
    STORE x28, 16*REGBYTES(sp)
    STORE x29, 17*REGBYTES(sp)
    STORE x30, 18*REGBYTES(sp)
    STORE x31, 19*REGBYTES(sp)
#endif /* __riscv_32e */
.endm

/**
 * \brief  Macro for restore caller registers
 * \details
 * This macro restore ABI defined caller saved registers from stack.
 * \remarks
 * - You could use this macro to restore context before you want return
 * from interrupt or exeception
 */
/* Restore caller registers */
.macro RESTORE_CONTEXT
    LOAD x1, 0*REGBYTES(sp)
    LOAD x4, 1*REGBYTES(sp)
    LOAD x5, 2*REGBYTES(sp)
    LOAD x6, 3*REGBYTES(sp)
    LOAD x7, 4*REGBYTES(sp)
    LOAD x10, 5*REGBYTES(sp)
    LOAD x11, 6*REGBYTES(sp)
    LOAD x12, 7*REGBYTES(sp)
    LOAD x13, 8*REGBYTES(sp)
    LOAD x14, 9*REGBYTES(sp)
    LOAD x15, 10*REGBYTES(sp)
#ifndef __riscv_32e
    LOAD x16, 14*REGBYTES(sp)
    LOAD x17, 15*REGBYTES(sp)
    LOAD x28, 16*REGBYTES(sp)
    LOAD x29, 17*REGBYTES(sp)
    LOAD x30, 18*REGBYTES(sp)
    LOAD x31, 19*REGBYTES(sp)

    /* De-allocate the stack space */
    addi sp, sp, 20*REGBYTES
#else
    /* De-allocate the stack space */
    addi sp, sp, 14*REGBYTES
#endif /* __riscv_32e */

.endm

/**
 * \brief  Macro for save necessary CSRs to stack
 * \details
 * This macro store MCAUSE, MEPC, MSUBM to stack.
 */
.macro SAVE_CSR_CONTEXT
    /* Store CSR mcause to stack using pushmcause */
    csrrwi  x0, CSR_PUSHMCAUSE, 11
    /* Store CSR mepc to stack using pushmepc */
    csrrwi  x0, CSR_PUSHMEPC, 12
    /* Store CSR msub to stack using pushmsub */
    csrrwi  x0, CSR_PUSHMSUBM, 13
.endm

/**
 * \brief  Macro for restore necessary CSRs from stack
 * \details
 * This macro restore MSUBM, MEPC, MCAUSE from stack.
 */
.macro RESTORE_CSR_CONTEXT
    LOAD x5,  13*REGBYTES(sp)
    csrw CSR_MSUBM, x5
    LOAD x5,  12*REGBYTES(sp)
    csrw CSR_MEPC, x5
    LOAD x5,  11*REGBYTES(sp)
    csrw CSR_MCAUSE, x5
.endm

/**
 * \brief  Exception/NMI Entry
 * \details
 * This function provide common entry functions for exception/nmi.
 * \remarks
 * This function provide a default exception/nmi entry.
 * ABI defined caller save register and some CSR registers
 * to be saved before enter interrupt handler and be restored before return.
 */
.section .text.trap
/* In CLIC mode, the exeception entry must be 64bytes aligned */
.align 6
.global exc_entry
.weak exc_entry
exc_entry:
    /* Save the caller saving registers (context) */
    SAVE_CONTEXT
    /* Save the necessary CSR registers */
    SAVE_CSR_CONTEXT

    /*
     * Set the exception handler function arguments
     * argument 1: mcause value
     * argument 2: current stack point(SP) value
     */
    csrr a0, mcause
    mv a1, sp
    /*
     * TODO: Call the exception handler function
     * By default, the function template is provided in
     * system_Device.c, you can adjust it as you want
     */
    call core_exception_handler

    /* Restore the necessary CSR registers */
    RESTORE_CSR_CONTEXT
    /* Restore the caller saving registers (context) */
    RESTORE_CONTEXT

    /* Return to regular code */
    mret

/**
 * \brief  Non-Vector Interrupt Entry
 * \details
 * This function provide common entry functions for handling
 * non-vector interrupts
 * \remarks
 * This function provide a default non-vector interrupt entry.
 * ABI defined caller save register and some CSR registers need
 * to be saved before enter interrupt handler and be restored before return.
 */
.section      .text.irq
/* In CLIC mode, the interrupt entry must be 4bytes aligned */
.align 2
.global irq_entry
.weak irq_entry
/* This label will be set to MTVT2 register */
irq_entry:
    /* Save the caller saving registers (context) */
    SAVE_CONTEXT
    /* Save the necessary CSR registers */
    SAVE_CSR_CONTEXT

    /* This special CSR read/write operation, which is actually
     * claim the CLIC to find its pending highest ID, if the ID
     * is not 0, then automatically enable the mstatus.MIE, and
     * jump to its vector-entry-label, and update the link register
     */
    csrrw ra, CSR_JALMNXTI, ra

    /* Critical section with interrupts disabled */
    DISABLE_MIE

    /* Restore the necessary CSR registers */
    RESTORE_CSR_CONTEXT
    /* Restore the caller saving registers (context) */
    RESTORE_CONTEXT

    /* Return to regular code */
    mret

/* Default Handler for Exceptions / Interrupts */
.global default_intexc_handler
.weak default_intexc_handler
Undef_Handler:
default_intexc_handler:
1:
	j 1b
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="core_template_linker_device.html" class="btn btn-neutral float-right" title="Device Linker Script: gcc_&lt;device&gt;.ld" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core_template_startup_device.html" class="btn btn-neutral float-left" title="Startup File startup_&lt;device&gt;.S" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Nuclei

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>